<link rel="import" href="../bower_components/polymer/polymer.html">
<dom-module id="x-play">
  <template></template>
  <script src="./js/buffer.js"></script>
  <script src="./js/player.js"></script>
  <script src="../bower_components/lodash/lodash.min.js"></script>
  <script>
    new Polymer({
      is: 'x-play',
      created: function() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        var context = new AudioContext();
        var player  = new Player(this, context);

        try {
          player.validate();
        } catch(e) {
          console.error(e);
          return;
        }

        var bufferLoader = new BufferLoader(context, player.props.sounds, function(bufferList) {

          var i, j, iMax, jMax, code, time, bpm, sound;

          time  = startTime = context.currentTime;
          bpm   = 60 / player.props.tempo;
          sound = player.props.sound;

          for (i = 0, iMax = player.props.repeat; i < iMax; i++) {
            for (j = 0, jMax = player.props.melody.length; j < jMax; j++) {
              time = startTime + (j * bpm);
              code = player.props.melody[j];
              if (_.indexOf(player.props.rests, code) === -1) {
                player.play(bufferList[sound], time, bpm, code);
              }
            }
            startTime = time + bpm;
          }
        });

        bufferLoader.load();
      }
    });
  </script>
</dom-module>
