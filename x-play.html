<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="x-play">
  <template>
    <style>
    </style>
    <button id="play" on-click="handlePlayClick">Play</button>
    <button id="pause" on-click="handlePauseClick">Pause</button>
  </template>

  <script src="./src/js/buffer.js"></script>
  <script src="./src/js/player.js"></script>
  <script>
    /**
     * `x-play`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class XPlay extends Polymer.Element {
      static get is() { return 'x-play'; }
      static get properties() {
        return {
          prop1: {
            type: String,
            value: 'x-play'
          }
        };
      }

      constructor() {
        super();

        window.AudioContext = window.AudioContext || window.webkitAudioContext;

        this.context = new AudioContext();
        this.player  = new Player(this, this.context);

        try {
          this.player.validate();
        } catch(e) {
          console.error(e);
          return;
        }
      }

      handlePlayClick() {
        this.play();
      }

      handlePauseClick() {
        this.pause();
      }

      play() {

        this.bufferLoader = new BufferLoader(this.context, this.player.props.sounds, (bufferList) => {

          const bpm = 60 / this.player.props.tempo;
          const sound = this.player.props.sound;

          let code, time, startTime;
          time = startTime = this.context.currentTime;

          for (let i = 0, iMax = this.player.props.repeat; i < iMax; i++) {
            for (let j = 0, jMax = this.player.props.melody.length; j < jMax; j++) {
              time = startTime + (j * bpm);
              code = this.player.props.melody[j];
              if (this.player.props.rests.indexOf(code) === -1) {
                this.player.play(bufferList[sound], time, bpm, code);
              }
            }
            startTime = time + bpm;
          }
        });

        this.bufferLoader.load();
      }

      pause() {

      }
    }

    window.customElements.define(XPlay.is, XPlay);
  </script>
</dom-module>
